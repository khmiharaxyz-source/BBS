<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mihara BBS</title>
    <link rel="icon" href="logo2.png" type="image/png">
    <link rel="apple-touch-icon" href="logo2.png">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #dcdcdc; display: flex; flex-direction: column; min-height: 100vh; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; flex: 1; padding: 10px; box-sizing: border-box; width: 100%; display: flex; flex-direction: column; position: relative; }
        input[type="text"], input[type="file"], input[type="password"], textarea { width: 100%; box-sizing: border-box; padding: 10px; margin: 5px 0; font-size: 16px !important; }
        #main-content { flex: 1; }
        .site-logo { display: block; max-width: 100%; height: auto; margin: 0 auto 10px; }
        .res-item { border-bottom: 1px solid #eee; padding: 15px 0; background: #fff; position: relative; scroll-margin-top: 80px; }
        .info { font-size: 0.85em; padding-right: 120px; word-wrap: break-word; }
        .name { color: #228b22; font-weight: bold; }
        .admin-name { color: #ff0000 !important; }
        .res-ops { position: absolute; top: 10px; right: 5px; display: flex; gap: 5px; }
        .op-btn { color: #666; font-size: 0.75em; cursor: pointer; border: 1px solid #ccc; padding: 2px 8px; background: #f9f9f9; border-radius: 3px; text-decoration: none; display: inline-block; }
        .admin-op-btn { background: #ff4500 !important; color: white !important; border-color: #d00 !important; }
        .aa { font-family: "Mona", "MS PGothic", "IPA P Gothic", sans-serif; font-size: 16px; line-height: 1.1; white-space: pre-wrap; margin: 10px 0; background: #fff; padding: 10px; border: 1px solid #eee; overflow-x: auto; word-break: break-all; }
        .uploaded-img { max-width: 100%; height: auto; display: block; margin: 10px 0; border: 1px solid #ccc; pointer-events: none; }
        .site-summary, .news-area { background: #fff; border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; font-size: 0.85em; position: relative; }
        .news-title { font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 8px; padding-bottom: 5px; color: #0047bd; }
        .rules { color: #d00; font-weight: bold; margin-top: 5px; white-space: pre-wrap; }
        .board-card { background: #fff; border: 1px solid #0047bd; padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .board-card h2 { margin: 0; color: #0047bd; font-size: 1.2em; }
        .thread-link { background: #fff; border: 1px solid #ccc; padding: 12px; margin-bottom: 8px; cursor: pointer; display: block; text-decoration: none; color: inherit; position: relative; }
        .nav-btn { background: #0047bd; color: #fff; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .nav-btn:disabled { background: #999 !important; cursor: not-allowed; }
        .post-form { background: #f0f0f5; padding: 12px; border: 1px solid #ccc; margin-bottom: 20px; }
        .hidden { display: none !important; }
        .anchor { color: #0047bd; text-decoration: underline; cursor: pointer; }
        .auto-link { color: #0047bd; text-decoration: underline; word-break: break-all; }
        .inner-footer { text-align: center; padding: 20px 10px; border-top: 1px solid #eee; font-size: 0.75em; color: #666; background-color: #fff; margin-top: auto; }
        .footer-banner { width: 200px; height: auto; display: block; margin: 10px auto; border: 1px solid #ccc; }
        .thread-nav-bar { position: sticky; top: 0; background-color: #fff; padding: 10px 0; z-index: 100; display: flex; gap: 8px; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
        .thread-del-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #f0f0f5; border: 1px solid #ccc; padding: 5px 8px; font-size: 0.7em; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="main-content">
        <div id="portal-view">
            <img src="logo.png" alt="mihara BBS" class="site-logo">
            <div class="site-summary">
                <div id="site-summary-display" style="white-space: pre-wrap;"></div>
                <div id="site-rules-display" class="rules"></div>
                <div id="admin-site-edit" class="hidden">
                    <textarea id="summary-input" onfocus="isEditing=true" onblur="isEditing=false"></textarea>
                    <button class="nav-btn" onclick="saveSummary()">サイト概要を更新</button>
                    <textarea id="rules-input" onfocus="isEditing=true" onblur="isEditing=false"></textarea>
                    <button class="nav-btn" onclick="saveRules()">利用規約を更新</button>
                </div>
            </div>
            <div id="news-container" class="news-area">
                <div class="news-title">お知らせ</div>
                <div id="news-text" style="white-space: pre-wrap;"></div>
                <div id="news-date" style="font-size: 0.8em; color: #888; text-align: right;"></div>
                <div id="admin-news-edit" class="hidden">
                    <textarea id="news-input" onfocus="isEditing=true" onblur="isEditing=false"></textarea>
                    <button class="nav-btn" onclick="saveNews()">お知らせを更新</button>
                </div>
            </div>
            <div id="board-portal"></div>
        </div>

        <div id="index-view" class="hidden">
            <button class="nav-btn" onclick="showPortal()">← 板一覧へ</button>
            <h1 id="current-board-name"></h1>
            <div id="board-description-area" style="padding:10px; border:1px solid #ccc; margin-bottom:10px; white-space:pre-wrap;"></div>
            <div id="admin-board-edit" class="hidden">
                <textarea id="board-desc-input" onfocus="isEditing=true" onblur="isEditing=false"></textarea>
                <button class="nav-btn" onclick="saveBoardDesc()">板概要を更新</button>
            </div>
            <div class="post-form">
                <strong>新規スレッド作成</strong><br>
                タイトル: <input type="text" id="new-title">
                名前: <input type="text" id="new-name">
                本文:<br><textarea id="new-content" oninput="checkLimit('new-content', 'new-char-info')"></textarea>
                <div id="new-char-info" style="font-size:0.75em;">0 / 3000</div>
                画像: <input type="file" id="new-file" accept="image/*">
                <button class="nav-btn" onclick="showConfirm()" style="width: 100%; padding: 12px; margin-top: 5px;">作成確認へ</button>
            </div>
            <div id="thread-list-container"></div>
        </div>

        <div id="thread-view" class="hidden">
            <div class="thread-nav-bar">
                <button class="nav-btn" onclick="openBoard(currentBoard)">← 戻る</button>
                <button class="nav-btn" onclick="scrollToBottom()">下へ ▼</button>
            </div>
            <h2 id="view-title" style="color:red;"></h2>
            <div id="res-list"></div>
            <div id="post-area-container"></div>
        </div>

        <div id="confirm-view" class="hidden">
            <div style="border:2px solid red; padding:20px; text-align:center; margin-top:20px;">
                <h3>投稿確認</h3>
                <p>荒らし目的のスレッド作成はおやめ下さい。</p>
                <div id="timer-msg" style="margin-bottom:15px; color:#666;"></div>
                <button id="btn-submit-thread" class="nav-btn" onclick="submitNewThread()" disabled>同意して作成</button>
                <button class="nav-btn" onclick="cancelNewThread()" style="background:#666; margin-left: 10px;">戻る</button>
            </div>
        </div>
    </div>

    <div id="global-footer" class="inner-footer">
        当サイトはリンクフリーです。<br>
        <img src="banner.png" class="footer-banner">
        <div id="admin-panel">
            <span id="admin-status">一般モード</span><br>
            <div id="login-form">
                <input type="text" id="admin-email" placeholder="email" style="width: 120px;">
                <input type="password" id="admin-pass" placeholder="pass" style="width: 80px;">
                <button onclick="login()">Login</button>
            </div>
            <button id="logout-btn" class="hidden" onclick="logout()">Logout</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB76FaBptbmuJEBbprV5cB4NOhQrPYokOw",
        authDomain: "mihara-bbs-cac0e.firebaseapp.com",
        projectId: "mihara-bbs-cac0e",
        databaseURL: "https://mihara-bbs-cac0e-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const BOARD_DEFAULTS = { '雑談': '雑談板です', 'AA絵一次': 'オリジナル板', 'AA絵二次': '二次創作板', 'YMM4': '素材板' };
    const NAME_DEFAULTS = { '雑談': '名無しの人', 'AA絵一次': '（　´∀｀）', 'AA絵二次': '(´・ω・)', 'YMM4': '名無し饅頭' };

    let currentBoard = "", currentThreadKey = null, isAdmin = false, isEditing = false, myId = "", countdownInterval = null, pendingThread = null;

    function init() {
        if (!localStorage.getItem('user_id')) localStorage.setItem('user_id', "ID:" + Math.random().toString(36).substring(2, 10).toUpperCase());
        myId = localStorage.getItem('user_id');

        auth.onAuthStateChanged(user => {
            isAdmin = !!user;
            document.getElementById('admin-status').innerText = isAdmin ? "管理者：三原" : "一般モード";
            document.getElementById('login-form').classList.toggle('hidden', isAdmin);
            document.getElementById('logout-btn').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-site-edit').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-news-edit').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-board-edit').classList.toggle('hidden', !isAdmin);
            if (currentThreadKey) refreshRes(); 
        });

        db.ref('site_settings/summary').on('value', s => { 
            const v = s.val() || ""; document.getElementById('site-summary-display').innerText = v; 
            if(!isEditing) document.getElementById('summary-input').value = v; 
        });
        db.ref('site_settings/rules').on('value', s => { 
            const v = s.val() || ""; document.getElementById('site-rules-display').innerText = v; 
            if(!isEditing) document.getElementById('rules-input').value = v; 
        });
        db.ref('site_news').on('value', s => { 
            const d = s.val() || {text:"",date:""}; document.getElementById('news-text').innerText = d.text; 
            document.getElementById('news-date').innerText = "最終更新: "+d.date; 
            if(!isEditing) document.getElementById('news-input').value = d.text; 
        });

        renderPortal();
        showPortal();
    }

    function saveSummary() { db.ref('site_settings/summary').set(document.getElementById('summary-input').value).then(()=>alert("更新完了")).catch(e=>alert("権限エラー: "+e.message)); }
    function saveRules() { db.ref('site_settings/rules').set(document.getElementById('rules-input').value).then(()=>alert("更新完了")).catch(e=>alert("権限エラー: "+e.message)); }
    function saveNews() { db.ref('site_news').set({ text: document.getElementById('news-input').value, date: new Date().toLocaleString() }).then(()=>alert("更新完了")); }
    function saveBoardDesc() { db.ref('board_settings/' + currentBoard + '/description').set(document.getElementById('board-desc-input').value).then(()=>alert("更新完了")); }

    function renderPortal() {
        const p = document.getElementById('board-portal'); p.innerHTML = "";
        Object.keys(BOARD_DEFAULTS).forEach(n => {
            const d = document.createElement('div'); d.className="board-card";
            d.onclick=()=>openBoard(n); d.innerHTML=`<h2>${n}板</h2>`; p.appendChild(d);
        });
    }

    function showPortal() {
        if (currentThreadKey) db.ref('boards/' + currentBoard + '/' + currentThreadKey + '/posts').off();
        currentThreadKey = null;
        document.getElementById('portal-view').classList.remove('hidden');
        document.getElementById('index-view').classList.add('hidden');
        document.getElementById('thread-view').classList.add('hidden');
        document.getElementById('confirm-view').classList.add('hidden');
    }

    function openBoard(name) {
        if (currentThreadKey) db.ref('boards/' + currentBoard + '/' + currentThreadKey + '/posts').off();
        currentBoard = name; currentThreadKey = null;
        document.getElementById('portal-view').classList.add('hidden');
        document.getElementById('index-view').classList.remove('hidden');
        document.getElementById('thread-view').classList.add('hidden');
        document.getElementById('current-board-name').innerText = name + "板";
        db.ref('board_settings/' + name + '/description').on('value', snap => {
            const val = snap.val() || BOARD_DEFAULTS[name];
            document.getElementById('board-description-area').innerText = val;
            if(!isEditing) document.getElementById('board-desc-input').value = val;
        });
        renderIndex();
    }

    function renderIndex() {
        const container = document.getElementById('thread-list-container');
        db.ref('boards/' + currentBoard).off();
        db.ref('boards/' + currentBoard).on('value', (snap) => {
            container.innerHTML = ""; const data = snap.val(); if (!data) return;
            Object.keys(data).sort((a,b)=>new Date(data[b].lastUpdate)-new Date(data[a].lastUpdate)).forEach(k => {
                const div = document.createElement('div'); div.className = "thread-link";
                div.onclick = () => showThread(k, data[k].title);
                div.innerHTML = `<strong>${data[k].title}</strong><div style="font-size:0.75em; color:#888;">${data[k].lastUpdate}</div>
                                 ${isAdmin ? `<button class="thread-del-btn" onclick="event.stopPropagation(); deleteThread('${k}')">削除</button>` : ""}`;
                container.appendChild(div);
            });
        });
    }

    function showThread(k, t) {
        if (currentThreadKey) db.ref('boards/' + currentBoard + '/' + currentThreadKey + '/posts').off();
        currentThreadKey = k;
        document.getElementById('index-view').classList.add('hidden');
        document.getElementById('thread-view').classList.remove('hidden');
        document.getElementById('view-title').innerText = t;
        db.ref('boards/' + currentBoard + '/' + k + '/posts').on('value', renderResponses);
        updatePostArea();
        window.scrollTo(0,0);
    }

    function updatePostArea() {
        document.getElementById('post-area-container').innerHTML = `
            <div class="post-form">
                <strong>レスを書く</strong><br>
                名前: <input type="text" id="res-name" placeholder="${NAME_DEFAULTS[currentBoard]}"><br>
                本文:<br><textarea id="res-content" oninput="handleResInput()"></textarea><br>
                <div id="res-char-info" style="font-size:0.75em;">0 / 3000</div>
                画像: <input type="file" id="res-file" accept="image/*">
                <button id="btn-post-res" class="nav-btn" onclick="postResponse()" disabled style="width:100%; padding:12px; margin-top:5px;">投稿</button>
                <div id="res-timer-label" style="font-size:0.75em; color:#666; margin-top:5px; text-align:center;">本文を入力してください</div>
            </div>`;
    }

    function handleResInput() {
        const a = document.getElementById('res-content'), b = document.getElementById('btn-post-res'), l = document.getElementById('res-timer-label');
        checkLimit('res-content', 'res-char-info');
        if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        b.disabled = true;
        if(!a.value.trim()) { l.innerText = "本文を入力してください"; return; }
        let s = 3; l.innerText = `あと${s}秒`;
        countdownInterval = setInterval(() => {
            s--;
            if(s <= 0) { l.innerText = "投稿可能"; b.disabled = false; clearInterval(countdownInterval); countdownInterval = null; }
            else { l.innerText = `あと${s}秒`; }
        }, 1000);
    }

    function postResponse() {
        const btn = document.getElementById('btn-post-res');
        if(btn.disabled) return; 
        btn.disabled = true;

        const n = isAdmin ? "三原" : (document.getElementById('res-name').value.trim() || NAME_DEFAULTS[currentBoard]);
        const body = document.getElementById('res-content').value;
        const time = new Date().toLocaleString();
        const file = document.getElementById('res-file').files[0];

        const send = (img) => {
            db.ref('boards/' + currentBoard + '/' + currentThreadKey + '/posts').push({ name: n, date: time, id: myId, body, img: img || "", deleted: false });
            db.ref('boards/' + currentBoard + '/' + currentThreadKey).update({ lastUpdate: time });
            updatePostArea();
        };

        if(file) { const r = new FileReader(); r.onload = (e) => send(e.target.result); r.readAsDataURL(file); } else send("");
    }

    function renderResponses(snap) {
        const list = document.getElementById('res-list'); list.innerHTML = ""; 
        const data = snap.val(); if(!data) return;
        
        // 【重要】>>1を固定し、投稿順に並べるロジック
        // keys().sort()をせず、Firebaseの自然な順番（Push順）で表示
        const entries = Object.entries(data);
        
        entries.forEach(([k, p], i) => {
            const num = i + 1;
            const div = document.createElement('div'); div.className = "res-item"; div.id = `res-${num}`;
            const opBtn = (isAdmin || p.id === myId) ? `<span class="op-btn" onclick="deletePost('${k}')">削除</span>` : "";
            const banBtn = isAdmin ? `<span class="op-btn admin-op-btn" onclick="toggleBan('${p.id}','${currentBoard}','${p.body}')">出禁</span>` : "";
            
            div.innerHTML = `<div class="info">${num}：<span class="${p.name==='三原'?'name admin-name':'name'}">${p.name}</span>：${p.date} <b>${p.id}</b></div>
                ${p.img && !p.deleted ? `<img src="${p.img}" class="uploaded-img">` : ""}
                <div class="aa">${p.deleted ? '<span style="color:red">削除されました</span>' : processText(p.body)}</div>
                <div class="res-ops"><span class="op-btn" onclick="insertAnchor(${num})">返信</span>${opBtn}${banBtn}</div>`;
            list.appendChild(div);
        });
    }

    function refreshRes() { db.ref('boards/' + currentBoard + '/' + currentThreadKey + '/posts').once('value', renderResponses); }
    function deletePost(k) { if(confirm("削除しますか？")) db.ref('boards/' + currentBoard + '/' + currentThreadKey + '/posts/' + k).update({ deleted: true }); }
    function deleteThread(k) { if(confirm("スレッドを削除しますか？")) db.ref('boards/' + currentBoard + '/' + k).remove(); }
    function toggleBan(tid, b, body) { if(confirm("出禁にしますか？")) db.ref('ban_list/' + tid.replace("ID:","")).set({ bannedAt: new Date().toLocaleString(), board: b, body: body.substring(0,50), id: tid }); }

    function showConfirm() {
        pendingThread = { title: document.getElementById('new-title').value, content: document.getElementById('new-content').value, img: "" };
        const f = document.getElementById('new-file').files[0];
        const go = (img) => {
            pendingThread.img = img; 
            document.getElementById('index-view').classList.add('hidden'); 
            document.getElementById('confirm-view').classList.remove('hidden');
            let s = 5; 
            const b = document.getElementById('btn-submit-thread'); 
            b.disabled = true;
            document.getElementById('timer-msg').innerText = `あと ${s} 秒`;
            const it = setInterval(() => { s--; document.getElementById('timer-msg').innerText = `あと ${s} 秒`; if(s <= 0) { clearInterval(it); b.disabled = false; document.getElementById('timer-msg').innerText = "投稿可"; } }, 1000);
        };
        if(f) { const r = new FileReader(); r.onload = (e) => go(e.target.result); r.readAsDataURL(f); } else go("");
    }

    function submitNewThread() {
        const b = document.getElementById('btn-submit-thread');
        if(b.disabled) return;
        b.disabled = true;

        const n = isAdmin ? "三原" : (document.getElementById('new-name').value || NAME_DEFAULTS[currentBoard]);
        const time = new Date().toLocaleString(), ref = db.ref('boards/' + currentBoard).push();
        ref.set({ title: pendingThread.title, lastUpdate: time, posts: { "0_first": { name: n, date: time, id: myId, body: pendingThread.content, img: pendingThread.img, deleted: false } } }).then(() => {
            document.getElementById('confirm-view').classList.add('hidden');
            showThread(ref.key, pendingThread.title);
        });
    }

    function cancelNewThread() { document.getElementById('confirm-view').classList.add('hidden'); document.getElementById('index-view').classList.remove('hidden'); }
    function processText(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" class="auto-link">$1</a>').replace(/&gt;&gt;(\d+)/g, '<span class="anchor" onclick="scrollToRes($1)">&gt;&gt;$1</span>'); }
    function checkLimit(a, b) { document.getElementById(b).innerText = document.getElementById(a).value.length + " / 3000"; }
    function scrollToRes(n) { const t = document.getElementById(`res-${n}`); if(t) t.scrollIntoView({ behavior: 'smooth' }); }
    function insertAnchor(n) { const tx = document.getElementById('res-content'); if(tx) { tx.value = `>>${n}\n` + tx.value; handleResInput(); tx.focus(); } }
    function scrollToBottom() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
    function login() { auth.signInWithEmailAndPassword(document.getElementById('admin-email').value, document.getElementById('admin-pass').value).catch(e=>alert("失敗")); }
    function logout() { auth.signOut(); }

    window.onload = init;
</script>
</body>
</html>